# 아이템 85. 자바 직렬화의 대안을 찾으라

## 직렬화

### 직렬화란?

기존의 자바는 정수, 문자열 바이트 단위의 처리만 지원했었다. <br>
복잡한 내용을 저장/복원 하거나, 네트워크로 전송하기 위해서는 객체의 멤버변수의 각 내용을 일정한 형식으로 만들어 전송해야 했는데, <br>
이를 위해 도입된 것이 **객체 직렬화**이다.

객체를 직렬화하고 싶다면, 간단히 `java.io.Serializable` 인터페이스를 구현하는 것으로 가능하다.<br>

```JAVA
    public class Member implements Serializable {
        private String name;
        private String email;
        private String phone;
      // 생략
    }
```

이 후, `ObjectOutputStream` 에서 `.writeObject()` 메서드 안에, 인스턴스 객체를 넣으면 된다.

직렬화를 하면 자바 I/O가 객체의 내용을 자동적으로 바이트 단위로 변환하는데, <br>
이를 `ObjectInputStream`의 `.readObject()` 메서드를 이용해 역직렬화하면 다시 객체로 만들어 사용할 수 있다.

### 직렬화의 문제점

직렬화의 근본적인 문제는 공격 범위가 너무 넓어 방어하기 어렵다는 점이다. <br>
이 문제는 역직렬화를 할 때 드러난다.

역직렬화에 사용되는 `.readObject()` 메서드는 그 어떤 객체도 Object 타입으로 만들어낼 수 있다.

공격 코드를 실은 객체를 이 코드가 실린 어플리케이션에 보내면, 이를 역직렬화하는 과정에서 그 타입들 안의 모든 코드를 수행할 수 있게 된다. <br>
즉, **타입의 모든 코드가 공격 범위에 들어간다는 것**이다.

따라서 자바의 표준 라이브러리나 아파치 커먼즈 컬렉션 같은 서드파티 라이브러리는 물론, 애플리케이션 자신의 클래스들도 공격 범위에 포함될 수 있다.

이는 아무리 공격에 대비해 코드를 작성해도, 여전히 취약할 수 있다.

  > **📌 참고**<br>
  > [[참고 기사](https://www.itworld.co.kr/news/206354#csidx62d187b76328fddba7b49555d9caf81)] <br>
  > 예를 들어 지난 7월 포지록(ForgeRock)의 오픈AM(OpenAM)에서 애플리케이션에 사용되는 자토(Jato) 프레임워크의 안전하지 않은 자바 역직렬화에 의해 치명적인 취약점(CVE-2021-35464)이 발생했다. 공격자는 간단한 GET 요청을 통해 자신이 제작한 직렬화된 객체를 서버로 전송해 악성코드를 실행할 수 있었다. 포트스위거(PortSwigger) 연구원 마이클 스테판킨이 시연한 PoC 익스플로잇에서 이에 대한 자세한 내용이 나온다. <br>
  > 더 최근에는 아틀라시안(Atlassian)이 기업 고객에 치명적인 JIRA 데이터센터 취약점 CVE-2020-36239를 패치하라는 이메일을 보냈다. 이 취약점은 원격 공격자가 취약한 서버에서 임의 코드를 실행할 수 있게 해준다. 이 취약점의 원인은 안전하지 않은 역직렬화와 노출된 포트다. 공격자는 노출된 Ehcache RMI 네트워크 서비스 포트 40001 또는 40011에 악성 페이로드를 전송해서 코드를 실행할 수 있다.

#### 역직렬화 공격 방법

1. 역직렬화 과정에서 호출되어 잠재적으로 위험한 동작을 수행하는 메서드들을 가젯(gadget) 이라고 부르는데, <br>
  여러 가젯을 함께 사용해 구성한 가젯 체인은 공격 대상의 기반 하드웨어 네이티브 코드를 마음대로 실행할 수 있도록 하기도 한다.

2. 역직렬화에 시간이 오래 걸리는 짧은 스트림을 역직렬화하는 것만으로도 서비스 거부 공격에 쉽게 노출될 수 있다. 이런 스트림을 역직렬화 폭탄(Deserialization bomb) 라고 부른다.

```JAVA
// 아래 메서드로 만들어진 직렬화 된 객체는 root 셋 내부에 재귀적으로 들어가는 100개의 다른 셋이 존재하는데,
// 이를 역직렬화하기 위해서는 내부적으로 .hashCode() 메서드를 2 ** 100 번 호출하도록 되어있어 문제가 생긴다.
static byte[] bomb() {
    Set<Object> root = new HashSet<>();
    Set<Object> s1 = root;
    Set<Object> s2 = new HashSet<>();
    for (int i = 0; i < 100; i++) {
        Set<Object> t1 = new HashSet<>();
        Set<Object> t2 = new HashSet<>();
        t1.add("foo");
        s1.add(t1);
        s1.add(t2);
        s2.add(t1);
        s2.add(t2);
        s1 = t1;
        s2 = t2;
    }
    return serialize(root);
}
```

### 회피 방법

1. 가장 좋은 방법은 **아무것도 역직렬화하지 않는 것이다.**

2. 직렬화를 해야만 한다면, 자바 직렬화가 아닌 **크로스 플랫폼 구조화된 데이터 표현(cross-platform structured-data representation)을 활용**하는 것도 좋다.
    - JSON : key-value 형식의 텍스트 형태로, 그 자체로 사람이 읽을 수 있다.
    - Protocol Buffers : 이진 형태의 스키마도 제공해, 효율이 높다.

3. 이미 자바 직렬화를 선택해 어쩔 수 없다면, **신뢰할 수 없는 데이터를 절대 역직렬화 하지 않아야 한다**.

4. 역직렬화한 데이터가 안전한지 완전히 확신할 수 없다면, **객체 역직렬화 필터링(`java.io.ObjectInputFilter`)을 사용**하자.
    - 역직렬화 이전에 필터를 설치하는 기능이다.
    - 두 가지 모드가 존재한다.
      - '기본 수용' 모드 : 블랙리스트 클래스들 거부
      - '기본 거부' 모드 : 화이트리스트 클래스들만 수용 (권장)